{% extends 'base/base.html' %}
{% load static %}
{% block title %}Car Booking System {% endblock title %}


{% block extracss %}
<link href="{% static 'calender/main.css' %}" rel="stylesheet" />
{% endblock extracss %}

{% block breadcrumb %}
<div>
  <h1><i class="fa fa-calendar"></i> Calendar</h1>
  <p>Car Booking system</p>
</div>
<ul class="app-breadcrumb breadcrumb">
  <li class="breadcrumb-item"><i class="fa fa-home fa-lg"></i></li>
  <li class="breadcrumb-item"><a>Calendar</a></li>
</ul>
{% endblock breadcrumb %}



{% block content %}
{% if form.non_field_errors %}
<div class="alert alert-danger">
  {{ form.non_field_errors }}
</div>
{% endif %}
<div class="row">
  <div class="col-md-12">
    <div class="tile row">
      <div class="col-md-3">
        <div id="external-events">
          <h4 class="mb-4">Running Events</h4>
          {% for event in events_month %}
          <div class="card mb-3 shadow-sm border-primary">
            <div class="card-body">
              <h5 class="card-title text-primary font-weight-bold">
                <i class="fa fa-car mr-2"></i>{{ event.title }}
              </h5>

              <p class="card-text mb-2">
                <strong>Car:</strong> {{ event.car.car_name }}
              </p>

              <p class="card-text mb-2">
                <strong>Description:</strong> {{ event.description }}
              </p>

              <p class="card-text mb-2">
                <strong>Booked By:</strong> {{ event.user.first_name }} {{ event.user.last_name }}
              </p>

              <p class="card-text mb-1">
                <strong>From:</strong> <i class="fa fa-clock-o ml-1"></i> {{ event.start_time|date:"D, d M Y H:i" }}
              </p>

              <p class="card-text">
                <strong>To:</strong> <i class="fa fa-clock-o ml-1"></i> {{ event.end_time|date:"D, d M Y H:i" }}
              </p>
            </div>
          </div>
          {% empty %}
          <p>No Running Events Found</p>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-9">
        <div id="calendar"></div>
      </div>

      <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="eventModalLabel">Add New Event</h5>
              <button id="modalClose1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>

            <!-- Modal Form -->
            <form method="post">
              {% csrf_token %}
              <div class="modal-body">

                <div class="form-group">
                  <label for="id_title">Event Title</label>
                  {{ form.title|add_class:"form-control" }}
                </div>

                <div class="form-group">
                  <label for="id_car">Car</label>
                  {{ form.car|add_class:"form-control" }}
                </div>

                <div class="form-group">
                  <label for="id_description">Description</label>
                  {{ form.description|add_class:"form-control" }}
                </div>

                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="id_start_time">Start Date</label>
                    {{ form.start_time }}
                  </div>
                  <div class="form-group col-md-6">
                    <label for="id_end_time">End Date</label>
                    {{ form.end_time }}
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button id="modalClose2" type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>

            </form>
          </div>
        </div>
      </div>
      <div class="modal fade show" id="detailModal" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white" id="title_event_detail"></h5>
        <button id="modalDetailClose" type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Form -->
      <form method="">
        {% csrf_token %}
        <div class="modal-body">
          <div class="container-fluid">

            <!-- Row 1 -->
            <div class="form-row mb-3">
              <div class="col-md-6">
                <label><strong>Description:</strong></label>
                <p class="mb-0" id="description_event_detail"></p>
              </div>
              <div class="col-md-6">
                <label><strong>Car Name:</strong></label>
                <p class="mb-0" id="car_event_detail"></p>
              </div>
            </div>

            <!-- Row 2 -->
            <div class="form-row mb-3">
              <div class="col-md-6">
                <label><strong>Start Date:</strong></label>
                <p class="mb-0" id="start_event_detail"></p>
              </div>
              <div class="col-md-6">
                <label><strong>End Date:</strong></label>
                <p class="mb-0" id="end_event_detail"></p>
              </div>
            </div>

            <!-- Row 3 -->
            <div class="form-row mb-2">
              <div class="col-md-6">
                <label><strong>Booked By:</strong></label>
                <p class="mb-0" id="booked_by_event_detail"></p>
              </div>
            </div>

          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <button id="delete-event-button" data-event-id="" type="button" class="btn btn-danger">Delete</button>
          <button id="add-to-next-week" data-event-id-week="" type="button" class="btn btn-success">Next Week</button>
          <button id="add-to-next-day" data-event-id-day="" type="button" class="btn btn-primary">Next Day</button>
        </div>
      </form>
    </div>
  </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}


{% block extrascripts %}
<script src="{% static 'calender/main.js' %}"></script>
<script>
  document.getElementById('id_start_time').addEventListener('click', function () {
    this._flatpickr.open();
  });

  // ==== Utility Functions ====

  // Format JS date to Django datetime string
  function converterDataParaDjangoFormat(data) {
    const dataJS = new Date(data);
    const year = dataJS.getFullYear();
    const month = (dataJS.getMonth() + 1).toString().padStart(2, '0');
    const day = dataJS.getDate().toString().padStart(2, '0');
    const hour = dataJS.getHours().toString().padStart(2, '0');
    const minute = dataJS.getMinutes().toString().padStart(2, '0');
    const second = dataJS.getSeconds().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
  }

  // Format date to YYYY-MM-DD for FullCalendar
  function formatDateLocalYYYYMMDD(d) {
    return d.getFullYear() + '-' +
      String(d.getMonth() + 1).padStart(2, '0') + '-' +
      String(d.getDate()).padStart(2, '0');
  }

  // Add months safely (handles shorter months correctly)
  function addMonthsSafe(date, months) {
    const origDay = date.getDate();
    const target = new Date(date);
    target.setMonth(target.getMonth() + months);

    if (target.getDate() !== origDay) {
      target.setDate(0); // last day of previous month
    }
    return target;
  }

  // Format for event detail modal
  function formatDateTime(dateTime) {
    if (!dateTime) return '';
    const options = {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short'
    };
    return new Date(dateTime).toLocaleDateString('en-US', options);
  }

  // ==== Calendar Init ====
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    const today = new Date();
    const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const endInclusive = addMonthsSafe(startDate, 3);
    const endExclusive = new Date(endInclusive);
    endExclusive.setDate(endExclusive.getDate() - 1); // FullCalendar end is exclusive

    console.log('validRange start:', formatDateLocalYYYYMMDD(startDate),
      'endInclusive:', formatDateLocalYYYYMMDD(endInclusive),
      'endExclusive:', formatDateLocalYYYYMMDD(endExclusive));

    const calendar = new FullCalendar.Calendar(calendarEl, {
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
      },
      validRange: {
        start: formatDateLocalYYYYMMDD(startDate),
        end: formatDateLocalYYYYMMDD(endExclusive)
      },
      initialDate: startDate,
      navLinks: true,
      selectable: true,
      selectMirror: true,

      // ==== When user selects a date/time range ====
      select: function (arg) {
        const modal = document.getElementById('eventModal');
        if (modal) modal.style.display = 'block';

        const startInput = document.getElementById('id_start_time');
        const endInput = document.getElementById('id_end_time');
        if (startInput) startInput.value = converterDataParaDjangoFormat(arg.start);
        if (endInput) endInput.value = converterDataParaDjangoFormat(arg.end);

        calendar.unselect();
      },

      // ==== When user clicks an existing event ====
      eventClick: function (arg) {
        const modal = document.getElementById('detailModal');
        if (!modal) return;

        document.getElementById('title_event_detail').textContent = arg.event.title || '';
        document.getElementById('start_event_detail').textContent = formatDateTime(arg.event.start);
        document.getElementById('end_event_detail').textContent = formatDateTime(arg.event.end);
        document.getElementById('description_event_detail').textContent = arg.event.extendedProps?.description || '';
        document.getElementById('car_event_detail').textContent = arg.event.extendedProps?.car_name || '';
        document.getElementById('booked_by_event_detail').textContent = arg.event.extendedProps.booked_by || '';


        // Attach event IDs to buttons for later actions
        document.getElementById('delete-event-button')?.setAttribute('data-event-id', arg.event.id);
        document.getElementById('add-to-next-week')?.setAttribute('data-event-id-week', arg.event.id);
        document.getElementById('add-to-next-day')?.setAttribute('data-event-id-day', arg.event.id);

        modal.style.display = 'block';
      },

      editable: true,
      dayMaxEvents: true,
      events: {{ events| safe }}
    });

  calendar.render();
  });
  const closeBtn1 = document.getElementById('modalClose1');
  const closeBtn2 = document.getElementById('modalClose2');
  const closeBtn3 = document.getElementById('modalDetailClose');
  closeBtn1.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn2.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn3.addEventListener('click', () => {
    const eventModal = document.getElementById('detailModal')
    eventModal.style.display = 'none';
  });
  function formatDateTime(dateTime) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
    const dataFormatada = new Date(dateTime).toLocaleDateString('en-US', options);
    return dataFormatada;
  };
  document.getElementById('delete-event-button').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id');
    if (confirm('Are you sure you want to delete this event?')) {
      $.ajax({
        url: `/delete_event/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }

      });
    }
  });

  document.getElementById('add-to-next-week').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-week');
    if (confirm('Are you sure you want add this event to next week?')) {
      $.ajax({
        url: `/next_week/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

  document.getElementById('add-to-next-day').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-day');
    if (confirm('Are you sure you want add this event to next day?')) {
      $.ajax({
        url: `/next_day/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

</script>
{% endblock extrascripts %}