{% extends 'base/base.html' %}
{% load static %}
{% block title %}Vehicle Reservation {% endblock title %}


{% block extracss %}
<link href="{% static 'calender/main.css' %}" rel="stylesheet" />
{% endblock extracss %}

{% block content %}
{% if form.non_field_errors %}
<div class="alert alert-danger" id="error-message">
  {{ form.non_field_errors }}
</div>
{% endif %}
{% if messages %}
  <div id="message-container">
    {% for message in messages %}
      <div class="alert 
                  {% if message.tags == 'error' %}
                    alert-danger
                  {% else %}
                    alert-{{ message.tags }}
                  {% endif %}" 
           role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
<div class="row">
  <div class="col-md-12">
    <div class="tile row">
     <div class="col-md-3 col-sm-6 col-xs-12">
    <h4 class="mb-3">ðŸš— Vehicle Program</h4>
    <ul id="vehicle-program-list" class="list-group">
      {% for program in vehicle_programs %}
      <li class="list-group-item vehicle-program-item" data-program-id="{{ program.id }}" >
        <span class="vehicle-program-name">{{ program.name }}</span>
        <ul class="car-list list-group mt-2" style="display: none;">
          {% for car in program.cars.all %}
          <li class="list-group-item car-item d-flex justify-content-between align-items-center
                                       {% if selected_car and car.id == selected_car.id %}active{% endif %}"
            data-car-id="{{ car.id }}">
            <span class="car-name">{{ car.car_name }}</span>
            <span class="badge badge-primary badge-pill car-unique">
              {{ car.car_unique_id }}
            </span>
            {% if car.id in available_cars_today %}
            <span class="available-dot"></span>
            {% endif %}
          </li>
          {% empty %}
          <li class="list-group-item text-muted">No cars available for this program</li>
          {% endfor %}
        </ul>
      </li>
      {% empty %}
      <li class="list-group-item text-muted">No vehicle programs available</li>
      {% endfor %}
    </ul>
</div>
      <div class="col-md-9">
        <div id="calendar"></div>
      </div>

      <div class="modal fade show" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="eventModalLabel">Add New Event</h5>
              <button id="modalClose1" type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>

            <!-- Modal Form -->
            <form method="post">
              {% csrf_token %}
              <div class="modal-body">

                <div class="form-group">
                  <label for="id_title">Event Title</label>
                  {{ form.title}}
                </div>
                <input type="hidden" id="id_car" name="car" value="{% if selected_car %}{{ selected_car.id }}{% endif %}">
                <!-- <div class="form-group">
                  <label for="id_car">Car</label>
                  {{ form.car}}
                </div> -->

                <div class="form-group">
                  <label for="id_description">Description</label>
                  {{ form.description }}
                </div>

                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label for="id_start_time">Start Date</label>
                    {{ form.start_time }}
                  </div>
                  <div class="form-group col-md-6">
                    <label for="id_end_time">End Date</label>
                    {{ form.end_time }}
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button id="modalClose2" type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>

            </form>
          </div>
        </div>
      </div>
      <div class="modal fade show" id="detailModal" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header bg-primary">
              <h5 class="modal-title text-white" id="title_event_detail"></h5>
              <button id="modalDetailClose" type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>

            <!-- Form -->
            <form method="">
              {% csrf_token %}
              <div class="modal-body">
                <div class="container-fluid">

                  <!-- Row 1 -->
                  <div class="form-row mb-3">
                    <div class="col-md-6">
                      <label><strong>Description:</strong></label>
                      <p class="mb-0" id="description_event_detail"></p>
                    </div>
                    <div class="col-md-6">
                      <label><strong>Car Name:</strong></label>
                      <p class="mb-0" id="car_event_detail"></p>
                    </div>
                  </div>

                  <!-- Row 2 -->
                  <div class="form-row mb-3">
                    <div class="col-md-6">
                      <label><strong>Start Date:</strong></label>
                      <p class="mb-0" id="start_event_detail"></p>
                    </div>
                    <div class="col-md-6">
                      <label><strong>End Date:</strong></label>
                      <p class="mb-0" id="end_event_detail"></p>
                    </div>
                  </div>

                  <!-- Row 3 -->
                  <div class="form-row mb-2">
                    <div class="col-md-6">
                      <label><strong>Booked By:</strong></label>
                      <p class="mb-0" id="booked_by_event_detail"></p>
                    </div>
                  </div>

                </div>
              </div>
 
              <!-- Modal Footer -->
              <div class="modal-footer">
                <button id="delete-event-button" data-event-id="" type="button" class="btn btn-danger">Delete</button>
                <button id="acknowledge-event-button" data-event-id="" type="button" class="btn btn-success" disabled>Acknowledge</button>
                <button id="add-to-next-week" data-event-id-week="" type="button" class="btn btn-success">Next Week</button>
                  <button id="add-to-next-day" data-event-id-day="" type="button" class="btn btn-primary">Next Day</button> 
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}


{% block extrascripts %}
<script src="{% static 'calender/main.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>

const vehicleProgramList = document.getElementById('vehicle-program-list');
if (vehicleProgramList) {
  vehicleProgramList.addEventListener('click', function(e) {
    const programItem = e.target.closest('.vehicle-program-item');
    if (programItem) {
      const carList = programItem.querySelector('.car-list');
      if (carList) {
        carList.style.display = carList.style.display === 'none' ? 'block' : 'none';
      }
    }
  });
}

const carList = document.getElementById('vehicle-program-list');
if (carList) {
  carList.addEventListener('click', function(e) {
    const carItem = e.target.closest('.car-item');
    if (carItem) {
      // Remove active class from all car items
      document.querySelectorAll('.car-item').forEach(item => item.classList.remove('active'));
      // Add active class to selected car item
      carItem.classList.add('active');

      // Remove active class from all vehicle program items
      document.querySelectorAll('.vehicle-program-item').forEach(item => item.classList.remove('active'));
      // Add active class to the vehicle program item that contains the selected car item
      carItem.closest('.vehicle-program-item').classList.add('active');

      const selectedCarId = carItem.getAttribute('data-car-id');
      const url = new URL(window.location.href);
      url.searchParams.set('car_id', selectedCarId);
      window.location.href = url.toString();
    }
  });
}
  
  document.getElementById('id_start_time').addEventListener('click', function () {
    this._flatpickr.open();
  });
  

  // ==== Utility Functions ====

  // Format JS date to Django datetime string
  function converterDataParaDjangoFormat(data) {
    const dataJS = new Date(data);
    const year = dataJS.getFullYear();
    const month = (dataJS.getMonth() + 1).toString().padStart(2, '0');
    const day = dataJS.getDate().toString().padStart(2, '0');
    const hour = dataJS.getHours().toString().padStart(2, '0');
    const minute = dataJS.getMinutes().toString().padStart(2, '0');
    const second = dataJS.getSeconds().toString().padStart(2, '0');
    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
  }

  // Format date to YYYY-MM-DD for FullCalendar
  function formatDateLocalYYYYMMDD(d) {
    return d.getFullYear() + '-' +
      String(d.getMonth() + 1).padStart(2, '0') + '-' +
      String(d.getDate()).padStart(2, '0');
  }

  // Add months safely (handles shorter months correctly)
  function addMonthsSafe(date, months) {
    const origDay = date.getDate();
    const target = new Date(date);
    target.setMonth(target.getMonth() + months);

    if (target.getDate() !== origDay) {
      target.setDate(0); // last day of previous month
    }
    return target;
  }

  // Format for event detail modal
  function formatDateTime(dateTime) {
    if (!dateTime) return '';
    const options = {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short'
    };
    return new Date(dateTime).toLocaleDateString('en-US', options);
  }

  // ==== Calendar Init ====
  document.addEventListener('DOMContentLoaded', function () {
    
    const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;

  let selectedCarId = {% if selected_car %}{{ selected_car.id }}{% else %}null{% endif %};

  // Define allowed date range: from today to 3 months later
{% if user.is_superuser %}
 const today = new Date();
const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

const endInclusive = addMonthsSafe(startDate, 3);
const endExclusive = new Date(endInclusive);
endExclusive.setDate(endExclusive.getDate() - 1); // FullCalendar end is exclusive
{% else %}
 const today = new Date();
const startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());

const endInclusive = addMonthsSafe(startDate, 1);
const endExclusive = new Date(endInclusive);
endExclusive.setDate(endExclusive.getDate() - 1); // FullCalendar end is exclusive
{% endif %}

let calendar = new FullCalendar.Calendar(calendarEl, {
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
  },
  initialView: 'timeGridWeek',
  height: 'auto',
  contentHeight: 'auto',
  expandRows: true,  // Ensures it expands instead of scrolls
  scrollTime: '00:00:00',  // Default scroll position (top)
  navLinks: true,
  selectable: true,
  selectMirror: true,
  editable: true,
  dayMaxEvents: true,
  validRange: {
    start: startDate,
    end: endExclusive
  },
    events: {{ events| safe }},
    select: function (arg) {
      if (!selectedCarId) {
        alert('Please select a car before booking.');
        calendar.unselect();
        return;
      }

      // Check if selected date is within valid range
      // if (arg.start < today || arg.end > maxDate) {
      //   alert('You can only book within the next 3 months.');
      //   calendar.unselect();
      //   return;
      // }

      const modal = document.getElementById('eventModal');
      if (modal) modal.style.display = 'block';

      const startInput = document.getElementById('id_start_time');
      const endInput = document.getElementById('id_end_time');
      if (startInput) startInput.value = converterDataParaDjangoFormat(arg.start);
      if (endInput) endInput.value = converterDataParaDjangoFormat(arg.end);

      calendar.unselect();
    },

      // ==== When user clicks an existing event ====
      eventClick: function (arg) {
        const modal = document.getElementById('detailModal');
        if (!modal) return;

        document.getElementById('title_event_detail').textContent = arg.event.title || '';
        document.getElementById('start_event_detail').textContent = formatDateTime(arg.event.start);
        document.getElementById('end_event_detail').textContent = formatDateTime(arg.event.end);
        document.getElementById('description_event_detail').textContent = arg.event.extendedProps?.description || '';
        document.getElementById('car_event_detail').textContent = arg.event.extendedProps?.car_name  || '';
        document.getElementById('booked_by_event_detail').textContent = arg.event.extendedProps.booked_by || '';


        // Attach event IDs to buttons for later actions
        document.getElementById('delete-event-button')?.setAttribute('data-event-id', arg.event.id);
        document.getElementById('add-to-next-week')?.setAttribute('data-event-id-week', arg.event.id);
        document.getElementById('add-to-next-day')?.setAttribute('data-event-id-day', arg.event.id);
        document.getElementById('acknowledge-event-button')?.setAttribute('data-event-id', arg.event.id);


        // Calculate time difference between now and event start
    const now = new Date();
    const eventStart = new Date(arg.event.start);
    const diffMs = eventStart - now;
    const diffMinutes = diffMs / (1000 * 60);

    // Enable Edit and Acknowledge buttons only if within 30 minutes prior to event start
    //const editBtn = document.getElementById('edit-event-button');
    const ackBtn = document.getElementById('acknowledge-event-button');

    if (diffMinutes <= 30 && diffMinutes >= 0) {
      //editBtn.disabled = false;
      ackBtn.disabled = false;
    } else {
      //editBtn.disabled = true;
      ackBtn.disabled = true;
    }

        modal.style.display = 'block';
      },

      
    

      editable: true,
      dayMaxEvents: true,
      events: {{ events| safe }}
    });

  calendar.render();

  const carList = document.getElementById('car-list');
  if (carList) {
    carList.addEventListener('click', function (e) {
  const carItem = e.target.closest('.car-item');
  if (carItem && carList.contains(carItem)) {
    // Remove active class from all
    document.querySelectorAll('.car-item').forEach(item => item.classList.remove('active'));
    // Add active class to selected
    carItem.classList.add('active');

    selectedCarId = carItem.getAttribute('data-car-id');

    // Reload page with car_id param
    const url = new URL(window.location.href);
    url.searchParams.set('car_id', selectedCarId);
    window.location.href = url.toString();
  }
});
  }

  });
  const closeBtn1 = document.getElementById('modalClose1');
  const closeBtn2 = document.getElementById('modalClose2');
  const closeBtn3 = document.getElementById('modalDetailClose');
  closeBtn1.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn2.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn3.addEventListener('click', () => {
    const eventModal = document.getElementById('detailModal')
    eventModal.style.display = 'none';
  });
  function formatDateTime(dateTime) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
    const dataFormatada = new Date(dateTime).toLocaleDateString('en-US', options);
    return dataFormatada;
  };
  document.getElementById('delete-event-button').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id');
    if (confirm('Are you sure you want to delete this event?')) {
      $.ajax({
        url: `/delete_event/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('You are not authorized to delete this event.');
        }

      });
    }
  });

  document.getElementById('add-to-next-week').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-week');
    if (confirm('Are you sure you want add this event to next week?')) {
      $.ajax({
        url: `/next_week/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

  document.getElementById('add-to-next-day').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-day');
    if (confirm('Are you sure you want add this event to next day?')) {
      $.ajax({
        url: `/next_day/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

</script>
<script>
  // Wait for the DOM to load
  document.addEventListener('DOMContentLoaded', function() {
    // Set timeout to hide error message after 20 seconds (20000 milliseconds)
    var errorMessage = document.getElementById('error-message');
    if (errorMessage) {
      setTimeout(function() {
        errorMessage.style.display = 'none';
      }, 10000);
    }

    // Set timeout to hide message container after 20 seconds
    var messageContainer = document.getElementById('message-container');
    if (messageContainer) {
      setTimeout(function() {
        messageContainer.style.display = 'none';
      }, 10000);
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
  const selectedCarId = {% if selected_car %}{{ selected_car.id }}{% else %}null{% endif %};
  if (selectedCarId) {
    const carItem = document.querySelector(`.car-item[data-car-id="${selectedCarId}"]`);
    if (carItem) {
      carItem.classList.add('active');
      const programItem = carItem.closest('.vehicle-program-item');
      if (programItem) {
        programItem.classList.add('active');
        const carList = programItem.querySelector('.car-list');
        if (carList) {
          carList.style.display = 'block';
        }
      }
    }
  }
});

const ackBtn = document.getElementById('acknowledge-event-button');
if (ackBtn) {
  ackBtn.addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id');
    if (confirm('Do you want to acknowledge this event?')) {
      $.ajax({
        url: `/acknowledge_event/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (response) {
          alert(response.message);
          const modal = document.getElementById('detailModal');
          if (modal) modal.style.display = 'none';
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error acknowledging event.');
        }
      });
    }
  });
}
</script>
{% endblock extrascripts %}